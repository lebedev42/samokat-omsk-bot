"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
require("dotenv/config");
const grammy_1 = require("grammy");
const query_string_1 = __importDefault(require("query-string"));
const qs_1 = __importDefault(require("qs"));
const got_1 = __importDefault(require("got"));
const jsdom_1 = require("jsdom");
const WEBAPP_URL = process.env.WEBAPP_URL;
const API_URL = process.env.API_URL;
const constants_1 = require("../constants");
const magicButton = (keyboard, ctx) => {
    return new keyboard().webApp(constants_1.MENU_TABLE, `${WEBAPP_URL}/index.html?user=${ctx.update.message.from.id}`);
};
const composer = new grammy_1.Composer();
composer.command("table", async (ctx) => {
    const keyboard = magicButton(grammy_1.InlineKeyboard, ctx);
    await ctx.reply(constants_1.MENU_TABLE, {
        reply_markup: keyboard
    });
});
composer.command("start", async (ctx) => {
    console.error("ctx", ctx);
    const keyboards = new grammy_1.Keyboard()
        .text(constants_1.MENU_RULES)
        .row()
        .text(constants_1.MENU_SEND)
        .row()
        .webApp(constants_1.MENU_TABLE, `${WEBAPP_URL}/index.html?user=${ctx.update.message.from.id}`)
        .resized();
    const user = await getPlayer(ctx.update.message.from.id);
    if (!user?.id) {
        await createPlayer(ctx.update.message.from);
        ctx.replyWithPhoto(`${constants_1.S3_BASE_URL}/sm-hello.png`, {
            caption: constants_1.HELLO_RESPONSE_1
        });
    }
    else {
        ctx.reply("Вы уже зарегистрированы");
    }
    await ctx.reply(constants_1.HELLO_RESPONSE_2, {
        reply_markup: keyboards
    });
});
composer.hears(constants_1.MENU_RULES, async (ctx) => {
    const stp1 = grammy_1.InputMediaBuilder.photo(`${constants_1.S3_BASE_URL}/stp-1.jpg`);
    const stp2 = grammy_1.InputMediaBuilder.photo(`${constants_1.S3_BASE_URL}/stp-2.jpg`);
    const stp3 = grammy_1.InputMediaBuilder.photo(`${constants_1.S3_BASE_URL}/stp-3.jpg`);
    const stp4 = grammy_1.InputMediaBuilder.photo(`${constants_1.S3_BASE_URL}/stp-4.jpg`);
    const stp5 = grammy_1.InputMediaBuilder.photo(`${constants_1.S3_BASE_URL}/stp-5.jpg`);
    const stp6 = grammy_1.InputMediaBuilder.photo(`${constants_1.S3_BASE_URL}/stp-6.jpg`);
    const stp7 = grammy_1.InputMediaBuilder.photo(`${constants_1.S3_BASE_URL}/stp-7.jpg`);
    ctx.reply(constants_1.MENU_RULES_RESPONSE_1);
    ctx.replyWithMediaGroup([stp1, stp2, stp3, stp4, stp5, stp6, stp7]);
    ctx.reply(`${constants_1.MENU_RULES_RESPONSE_2} ${constants_1.RULES_TEXT_LINK}`, {
        parse_mode: "HTML",
        disable_web_page_preview: true
    });
});
composer.hears(constants_1.MENU_SEND, async (ctx) => {
    ctx.reply("Начнем соревнования! Отправьте сюда ваш чек из приложения");
});
// получение ссылки на чек
composer.on("message:text", async (ctx) => {
    if (ctx.msg.text.includes(constants_1.OFD_URL)) {
        try {
            const url = new URL(ctx.msg.text);
            const parsedData = query_string_1.default.parse(url.search);
            if (isOFD(parsedData, constants_1.OFD_URL_FIELDS) &&
                typeof parsedData.date === "string") {
                if (parseInt(parsedData.date) > constants_1.GAME_START_TIME) {
                    const checkSum = await parseCheckURL(url.href);
                    console.error("checkSum", checkSum);
                    await saveTransaction(parsedData, checkSum, ctx);
                    sendConfirmMessage(ctx);
                    await savePlayerPoints(checkSum, ctx);
                    sendSuccessMessage(ctx);
                }
                else {
                    throw new Error();
                }
            }
            else {
                throw new Error();
            }
        }
        catch (error) {
            sendFileCommonErrorMessage(ctx);
            return false;
        }
    }
    else {
        sendFileCommonErrorMessage(ctx);
    }
});
function isOFD(params, check) {
    const paramsFields = new Set(Object.keys(params));
    return check.filter((i) => paramsFields.has(i)).length === check.length;
}
async function sendFileCommonErrorMessage(ctx) {
    ctx.replyWithPhoto(`${constants_1.S3_BASE_URL}/sm-error.png`, {
        caption: constants_1.ERROR_TEXT,
        parse_mode: "HTML",
        disable_web_page_preview: true
    });
}
async function sendConfirmMessage(ctx) {
    ctx.replyWithPhoto(`${constants_1.S3_BASE_URL}/sm-success.png`, {
        caption: constants_1.SUCCESS_1_TEXT
    });
}
async function sendSuccessMessage(ctx) {
    ctx.reply(constants_1.SUCCESS_2_TEXT);
}
async function parseCheckURL(url) {
    return (0, got_1.default)(url)
        .then((response) => {
        const { document } = new jsdom_1.JSDOM(response.body).window;
        const textContent = document
            .getElementById("fido_cheque_container")
            .textContent.replace(/\s+/g, "");
        const isSamokat = textContent.includes("www.samokat.ru");
        if (!isSamokat) {
            throw new Error();
        }
        const match = textContent.match(/(<b>=<span>([]*.*)<\/span><\/b>)/gi);
        const el = document.createElement("div");
        el.innerHTML = match[0];
        const checkSum = el.children[0].textContent.slice(1);
        return parseInt(checkSum);
    })
        .catch((err) => {
        throw new Error();
    });
}
async function getPlayer(id) {
    const query = qs_1.default.stringify({
        filters: {
            ["tgId"]: {
                $eq: id
            }
        }
    });
    return fetch(`${API_URL}/api/players?${query}`, {
        method: "get",
        headers: {
            "Content-Type": "application/json",
            Authorization: constants_1.API_AUTH_TOKEN
        }
    })
        .then((res) => res.json())
        .then((data) => {
        if (!Array.isArray(data.data) && data?.error) {
            throw new Error("FIND PLAYER ERROR");
        }
        return data.data[0];
    })
        .catch((error) => {
        throw new Error("FIND PLAYER ERROR");
    });
}
async function createPlayer(data) {
    const player = {
        name: data.username,
        firstName: data.first_name,
        lastName: data.last_name,
        tgId: data.id.toString()
    };
    return fetch(`${API_URL}/api/players`, {
        method: "post",
        headers: {
            "Content-Type": "application/json",
            Authorization: constants_1.API_AUTH_TOKEN
        },
        body: JSON.stringify({ data: { ...player } })
    }).catch(() => {
        throw new Error("CREATE PLAYER ERROR");
    });
}
async function saveTransaction(data, checkSum, ctx) {
    const user = await getPlayer(ctx.update.message.from.id);
    if (!user?.id) {
        return false;
    }
    const transaction = {
        ofd_url: ctx.update.message.text,
        ofd_date: data.date,
        ofd_id: data.id,
        ofd_fp: data.fp,
        sum: checkSum,
        player: user.id
    };
    return fetch(`${API_URL}/api/transactions`, {
        method: "post",
        headers: {
            "Content-Type": "application/json",
            Authorization: constants_1.API_AUTH_TOKEN
        },
        body: JSON.stringify({ data: { ...transaction } })
    })
        .then((res) => res.json())
        .then((data) => {
        console.error("data?.error", data?.error);
        if (!Array.isArray(data) && data?.error) {
            throw new Error("CREATE TRANSACTION ERROR");
        }
        return data.data[0];
    })
        .catch((error) => {
        throw new Error("CREATE TRANSACTION ERROR");
    });
}
async function savePlayerPoints(checkSum, ctx) {
    const user = await getPlayer(ctx.update.message.from.id);
    if (!user?.id) {
        return false;
    }
    const newPoints = user.attributes.points + (checkSum / 600).toFixed(2);
    const updatedData = {
        points: newPoints
    };
    return fetch(`${API_URL}/api/players/${user.id}`, {
        method: "put",
        headers: {
            "Content-Type": "application/json",
            Authorization: constants_1.API_AUTH_TOKEN
        },
        body: JSON.stringify({ data: { ...updatedData } })
    })
        .then((res) => res.json())
        .then((data) => {
        console.error("data", data);
        if (!Array.isArray(data) && data?.error) {
            throw new Error("SAVE PLAYER POINTS ERROR");
        }
    })
        .catch((error) => {
        throw new Error("SAVE PLAYER POINTS ERROR");
    });
}
exports.default = composer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYm90L2hhbmRsZXJzL2NvbW1hbmRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEseUJBQXVCO0FBQ3ZCLG1DQUErRTtBQUUvRSxnRUFBdUM7QUFFdkMsNENBQW9CO0FBQ3BCLDhDQUFzQjtBQUN0QixpQ0FBOEI7QUFFOUIsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7QUFDMUMsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUM7QUFFcEMsNENBaUJzQjtBQUV0QixNQUFNLFdBQVcsR0FBRyxDQUFDLFFBQWEsRUFBRSxHQUFRLEVBQTZCLEVBQUU7SUFDekUsT0FBTyxJQUFJLFFBQVEsRUFBRSxDQUFDLE1BQU0sQ0FDMUIsc0JBQVUsRUFDVixHQUFHLFVBQVUsb0JBQW9CLEdBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FDOUQsQ0FBQztBQUNKLENBQUMsQ0FBQztBQUVGLE1BQU0sUUFBUSxHQUFHLElBQUksaUJBQVEsRUFBVyxDQUFDO0FBRXpDLFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUN0QyxNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsdUJBQWMsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUVsRCxNQUFNLEdBQUcsQ0FBQyxLQUFLLENBQUMsc0JBQVUsRUFBRTtRQUMxQixZQUFZLEVBQUUsUUFBUTtLQUN2QixDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUN0QyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUUxQixNQUFN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